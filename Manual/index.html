<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkmate - keep your streaks alive</title>
    
    <!-- Premium Font: Poppins & Space Grotesk (Gen Z Vibes) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;900&family=Space+Grotesk:wght@400;500;600;700&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CSS VARIABLES & THEME
           ========================================= */
        :root {
            /* Backgrounds */
            --bg-body: #030305;
            --bg-card: #0F0F12;
            
            /* Accents */
            --accent-blue: #1d4ed8;       
            --accent-blue-hover: #2563eb;
            --accent-red: #dc2626;        
            --accent-red-hover: #ef4444;
            
            /* Status Colors */
            --status-success: #22c55e;
            --status-fail: #ef4444;
            --status-mod: #eab308;

            /* Borders & Text */
            --border-color: #27272a;
            --text-main: #ffffff;
            --text-muted: #9ca3af;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Bubbles Background */
        .bubbles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.25;
            animation: float 12s infinite ease-in-out;
        }

        .bubble:nth-child(1) {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            left: 5%;
            top: 10%;
            animation-duration: 12s;
            animation-delay: 0s;
        }

        .bubble:nth-child(2) {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            right: 10%;
            top: 25%;
            animation-duration: 15s;
            animation-delay: -5s;
        }

        .bubble:nth-child(3) {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            left: 50%;
            top: 15%;
            animation-duration: 13s;
            animation-delay: -10s;
        }

        .bubble:nth-child(4) {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #eab308, #f59e0b);
            left: 15%;
            top: 60%;
            animation-duration: 16s;
            animation-delay: -8s;
        }

        .bubble:nth-child(5) {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            right: 20%;
            top: 70%;
            animation-duration: 14s;
            animation-delay: -15s;
        }

        .bubble:nth-child(6) {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #06b6d4, #22d3ee);
            left: 70%;
            top: 40%;
            animation-duration: 15s;
            animation-delay: -12s;
        }

        .bubble:nth-child(7) {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #ec4899, #f472b6);
            left: 30%;
            top: 30%;
            animation-duration: 14s;
            animation-delay: -3s;
        }

        .bubble:nth-child(8) {
            width: 85px;
            height: 85px;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            right: 35%;
            top: 55%;
            animation-duration: 16s;
            animation-delay: -18s;
        }

        .bubble:nth-child(9) {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #22c55e, #4ade80);
            left: 80%;
            top: 80%;
            animation-duration: 13s;
            animation-delay: -7s;
        }

        .bubble:nth-child(10) {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            right: 5%;
            top: 50%;
            animation-duration: 17s;
            animation-delay: -20s;
        }

        .bubble:nth-child(11) {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #8b5cf6, #c084fc);
            left: 40%;
            top: 75%;
            animation-duration: 15s;
            animation-delay: -14s;
        }

        .bubble:nth-child(12) {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #06b6d4, #67e8f9);
            right: 50%;
            top: 20%;
            animation-duration: 14s;
            animation-delay: -6s;
        }

        .bubble:nth-child(13) {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #f43f5e, #fb7185);
            left: 25%;
            top: 45%;
            animation-duration: 13s;
            animation-delay: -2s;
        }

        .bubble:nth-child(14) {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #10b981, #34d399);
            right: 45%;
            top: 65%;
            animation-duration: 15s;
            animation-delay: -9s;
        }

        .bubble:nth-child(15) {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #f59e0b, #fb923c);
            left: 60%;
            top: 25%;
            animation-duration: 14s;
            animation-delay: -11s;
        }

        .bubble:nth-child(16) {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            right: 30%;
            top: 35%;
            animation-duration: 16s;
            animation-delay: -4s;
        }

        .bubble:nth-child(17) {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #14b8a6, #2dd4bf);
            left: 10%;
            top: 85%;
            animation-duration: 13s;
            animation-delay: -16s;
        }

        .bubble:nth-child(18) {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #d946ef, #e879f9);
            right: 15%;
            top: 10%;
            animation-duration: 15s;
            animation-delay: -13s;
        }

        .bubble:nth-child(19) {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            left: 35%;
            top: 5%;
            animation-duration: 14s;
            animation-delay: -19s;
        }

        .bubble:nth-child(20) {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #84cc16, #a3e635);
            right: 25%;
            top: 90%;
            animation-duration: 16s;
            animation-delay: -1s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(20px, -30px) scale(1.05);
            }
            50% {
                transform: translate(-15px, -50px) scale(0.95);
            }
            75% {
                transform: translate(25px, -25px) scale(1.02);
            }
        }

        #app-container {
            width: 100%;
            position: relative;
            z-index: 1;
            /* Ensure it's wide enough to fit 31 days comfortably, 
               but fits within viewport */
            max-width: 1600px; 
            min-width: 1000px; 
        }

        /* =========================================
           2. HEADER & CONTROLS
           ========================================= */
        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3.2rem;
            font-weight: 900;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin: 0;
            text-shadow: 0 4px 20px rgba(29, 78, 216, 0.3);
            font-family: 'Playfair Display', serif;
            color: var(--text-main);
            position: relative;
            word-spacing: 0.1em;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .date-selectors {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            color: var(--text-muted);
        }

        .custom-select {
            background: #111;
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            color: white;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add { background-color: var(--accent-blue); }
        .btn-add:hover { background-color: var(--accent-blue-hover); }

        .btn-reset { background-color: var(--accent-red); }
        .btn-reset:hover { background-color: var(--accent-red-hover); }

        /* Notification Panel */
        .notification-panel {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background-color: rgba(29, 78, 216, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .notification-panel label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .notification-panel input[type="time"] {
            background: #111;
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: inherit;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
        }

        .notification-panel input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .btn-notify {
            background-color: #22c55e;
            padding: 8px 16px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .btn-notify:hover { background-color: #16a34a; }
        .btn-notify.active { background-color: #16a34a; }

        /* =========================================
           3. MAIN CARD & GRID (FIXED LAYOUT)
           ========================================= */
        .main-card {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #1e1e24;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        /* REMOVED overflow-x: auto to prevent scrolling */
        .table-container {
            width: 100%;
            margin-bottom: 15px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            /* This forces the table to respect widths and not expand/scroll */
            table-layout: fixed; 
        }

        /* Header Row */
        th {
            background-color: #08080a;
            color: white;
            font-size: 0.8rem;
            font-weight: 700;
            padding: 12px 2px; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid #1a1a1a;
            text-align: center;
        }

        /* First Column Header (Fixed Width) */
        th.habit-head {
            text-align: left;
            padding-left: 20px;
            width: 250px; /* Fixed width for names */
            background-color: #08080a;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            border-right: 2px solid var(--border-color);
        }

        /* Habit Rows */
        tr { border-bottom: 1px solid #1a1a1a; }
        tr:last-child { border-bottom: none; }

        /* Habit Name Cell */
        td.habit-name {
            background-color: var(--bg-card);
            border-right: 2px solid var(--border-color);
            padding: 0;
            height: 45px;
            width: 250px; /* Match header */
            position: relative;
        }

        input.habit-input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: white;
            padding: 0 15px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        input.habit-input::placeholder { color: #444; font-style: italic; }

        .del-btn {
            position: absolute;
            right: 5px; top: 0; bottom: 0;
            margin: auto;
            background: none; border: none; color: #444;
            font-size: 1.2rem; cursor: pointer; opacity: 0;
            transition: 0.2s;
        }
        td.habit-name:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: var(--accent-red); }

        /* Day Cells */
        td.day-cell {
            /* No fixed width, they share remaining space equally */
            height: 45px;
            text-align: center;
            border-right: 1px solid #1a1a1a;
            cursor: pointer;
            user-select: none;
            transition: background 0.1s;
            padding: 0;
        }
        td.day-cell:hover { background-color: #1a1a1e; }

        .status-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem; /* Slightly smaller to fit 31 cols */
            width: 100%;
            height: 100%;
        }

        /* State Styles */
        .s-1 { color: var(--status-success); background: rgba(34, 197, 94, 0.1); }
        .s-2 { color: var(--status-fail); background: rgba(239, 68, 68, 0.1); }
        .s-3 { color: var(--status-mod); background: rgba(234, 179, 8, 0.1); }


        /* =========================================
           4. FOOTER LEGEND
           ========================================= */
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            padding-top: 5px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-green { background-color: var(--status-success); }
        .dot-red { background-color: var(--status-fail); }
        .dot-yellow { background-color: var(--status-mod); }

        /* Page Footer */
        .page-footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border-color);
        }
        .page-footer p { margin: 5px 0; }
        .page-footer .developer { 
            font-weight: 600; 
            color: var(--text-main);
        }
        .page-footer .best-wishes {
            color: var(--accent-blue);
            font-weight: 600;
            margin-top: 10px;
        }

        /* =========================================
           5. MOBILE RESPONSIVE STYLES
           ========================================= */
        @media (max-width: 1024px) {
            #app-container {
                min-width: 100%;
                max-width: 100%;
                padding: 0;
            }

            body {
                padding: 20px 10px;
            }

            h1 {
                font-size: 2.2rem;
                letter-spacing: 1px;
            }

            header h4 {
                font-size: 0.85rem;
            }

            .controls-bar {
                flex-direction: column;
                gap: 15px;
            }

            .date-selectors {
                flex-wrap: wrap;
                justify-content: center;
            }

            .btn-group {
                width: 100%;
                justify-content: center;
            }

            .notification-panel {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .notification-panel label,
            .notification-panel input,
            .notification-panel button {
                width: 100%;
            }

            .main-card {
                padding: 10px;
                border-radius: 12px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            th, td.day-cell {
                min-width: 30px;
                font-size: 0.7rem;
                padding: 8px 1px;
            }

            th.habit-head,
            td.habit-name {
                width: 150px;
                min-width: 150px;
            }

            input.habit-input {
                font-size: 0.8rem;
                padding: 0 10px;
            }

            .status-marker {
                font-size: 0.8rem;
            }

            .footer {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .legend {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }

            button {
                padding: 12px 20px;
                font-size: 1rem;
                min-height: 44px; /* iOS touch target */
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 15px 5px;
            }

            h1 {
                font-size: 1.8rem;
            }

            header {
                padding: 20px 10px;
                margin-bottom: 20px;
            }

            .controls-bar {
                gap: 12px;
            }

            .date-selectors {
                font-size: 0.9rem;
            }

            .custom-select {
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            th, td.day-cell {
                min-width: 25px;
                font-size: 0.65rem;
                padding: 6px 0;
            }

            th.habit-head,
            td.habit-name {
                width: 120px;
                min-width: 120px;
            }

            input.habit-input {
                font-size: 0.75rem;
            }

            .status-marker {
                font-size: 0.7rem;
            }

            .page-footer {
                font-size: 0.75rem;
                padding: 15px 10px;
            }

            .legend {
                font-size: 0.7rem;
            }

            .btn-add span,
            .btn-reset span {
                display: none;
            }

            .btn-add::before {
                content: '+';
            }

            .btn-reset::before {
                content: 'â†»';
            }
        }

        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            td.day-cell {
                -webkit-tap-highlight-color: rgba(29, 78, 216, 0.2);
            }

            button {
                -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
            }

            input, select {
                font-size: 16px; /* Prevents iOS zoom */
            }
        }

    </style>
</head>
<body>

    <!-- Animated Bubbles Background -->
    <div class="bubbles-container">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <div id="app-container">
        
        <header>
            <h1>Checkmate</h1>
            <h4 style="color: rgb(222, 222, 73);">keep your streaks alive</h4>
        </header>

        <div class="controls-bar">
            <div class="date-selectors">
                <span>Monthly Goals for:</span>
                <select id="monthSelect" class="custom-select" onchange="saveMeta()">
                    <option>January</option><option>February</option><option>March</option>
                    <option>April</option><option>May</option><option>June</option>
                    <option>July</option><option>August</option><option>September</option>
                    <option>October</option><option>November</option><option selected>December</option>
                </select>
                <input type="number" id="yearSelect" class="custom-select" value="2027" min="2020" max="2100" step="1" onchange="saveMeta()" style="width: 80px;">
            </div>

            <div class="btn-group">
                <button class="btn-add" onclick="addHabit()">
                    <span>+ Add Habit</span>
                </button>
                <button class="btn-reset" onclick="resetGrid()">
                    <span>â†» Reset</span>
                </button>
            </div>
        </div>

        <!-- Notification Panel -->
        <div class="notification-panel">
            <label>
                <input type="checkbox" id="notifyToggle" onchange="toggleNotification()">
                Daily Reminder
            </label>
            <input type="time" id="notifyTime" value="19:00" onchange="updateNotifyTime()">
            <button class="btn-notify" onclick="testNotification()">ðŸ”” Test Notification</button>
        </div>

        <div class="main-card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr id="headerRow">
                            <th class="habit-head">HABITS / BEHAVIORS</th>
                            <!-- Days 1-31 injected here -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Habits injected here -->
                    </tbody>
                </table>
            </div>

            <div class="footer">
                <div class="legend">
                    <div class="legend-item"><div class="dot dot-green"></div> Mission Successful</div>
                    <div class="legend-item"><div class="dot dot-red"></div> Incomplete</div>
                    <div class="legend-item"><div class="dot dot-yellow"></div> Moderate</div>
                </div>
                <div>Track your daily habits and behaviors by clicking on the cells.</div>
            </div>
        </div>

        <div class="page-footer">
            <p class="developer">Designed & Developed by Thulasiraman</p>
            <p>&copy; 2025 All Rights Reserved</p>
            <p class="best-wishes"><i>The process of building habits is actually the process of becoming yourself</i></p>
        </div>

    </div>

<script>
    // Check localStorage availability
    function isLocalStorageAvailable() {
        try {
            const test = '__localStorage_test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch(e) {
            console.warn('localStorage not available, using in-memory storage');
            return false;
        }
    }

    // Fallback in-memory storage for privacy mode or restricted environments
    const memoryStorage = {};
    const storage = isLocalStorageAvailable() ? localStorage : {
        getItem: (key) => memoryStorage[key] || null,
        setItem: (key, value) => { memoryStorage[key] = value; },
        removeItem: (key) => { delete memoryStorage[key]; }
    };

    const DAYS_COUNT = 31;
    const DATA_KEY = 'tracker_fixed_data';
    const META_KEY = 'tracker_fixed_meta';
    
    // Symbols: 0=Empty, 1=Tick, 2=Cross, 3=Dot
    const SYMBOLS = ['', 'âœ“', 'âœ•', '-']; 
    const CLASSES = ['', 's-1', 's-2', 's-3'];

    let habits = [];

    function init() {
        try {
            // Load Meta
            const meta = JSON.parse(storage.getItem(META_KEY));
            if(meta) {
                document.getElementById('monthSelect').value = meta.month;
                document.getElementById('yearSelect').value = meta.year;
            }

            // Load Data
            const savedData = storage.getItem(DATA_KEY);
            if(savedData) {
                habits = JSON.parse(savedData);
            } else {
                habits = [
                    { name: "Waking up early", days: Array(DAYS_COUNT).fill(0) },
                    { name: "Gym / Exercise", days: Array(DAYS_COUNT).fill(0) },
                    { name: "Reading", days: Array(DAYS_COUNT).fill(0) },
                    { name: "", days: Array(DAYS_COUNT).fill(0) }
                ];
            }
            render();
        } catch(e) {
            console.error('Error initializing app:', e);
            // Fallback to default data
            habits = [
                { name: "Waking up early", days: Array(DAYS_COUNT).fill(0) },
                { name: "Gym / Exercise", days: Array(DAYS_COUNT).fill(0) },
                { name: "Reading", days: Array(DAYS_COUNT).fill(0) },
                { name: "", days: Array(DAYS_COUNT).fill(0) }
            ];
            render();
        }
    }

    function render() {
        try {
            const headerRow = document.getElementById('headerRow');
            const tableBody = document.getElementById('tableBody');

            // Header
            if(headerRow.children.length === 1) {
                for(let i=1; i<=DAYS_COUNT; i++) {
                    const th = document.createElement('th');
                    th.textContent = i;
                    headerRow.appendChild(th);
                }
            }

            // Body
            tableBody.innerHTML = '';
            habits.forEach((habit, rIdx) => {
                const tr = document.createElement('tr');

                // Name
                const tdName = document.createElement('td');
                tdName.className = 'habit-name';
                const safeHabitName = (habit.name || '').replace(/"/g, '&quot;');
                tdName.innerHTML = `
                    <input class="habit-input" value="${safeHabitName}" 
                           placeholder="New habit..." 
                           onchange="updateName(${rIdx}, this.value)">
                    <button class="del-btn" onclick="deleteHabit(${rIdx})">Ã—</button>
                `;
                tr.appendChild(tdName);

                // Days
                habit.days.forEach((val, cIdx) => {
                    const td = document.createElement('td');
                    td.className = `day-cell ${CLASSES[val]}`;
                    td.innerHTML = `<div class="status-marker">${SYMBOLS[val]}</div>`;
                    td.onclick = () => toggleCell(rIdx, cIdx);
                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        } catch(e) {
            console.error('Error rendering:', e);
        }
    }

    function toggleCell(r, c) {
        let current = habits[r].days[c];
        let next = (current + 1) % 4; 
        habits[r].days[c] = next;
        save();
        render();
    }

    function updateName(idx, val) {
        habits[idx].name = val;
        save();
    }

    function addHabit() {
        habits.push({ name: "", days: Array(DAYS_COUNT).fill(0) });
        save();
        render();
    }

    function deleteHabit(idx) {
        if(confirm("Delete this habit row?")) {
            habits.splice(idx, 1);
            save();
            render();
        }
    }

    function resetGrid() {
        if(confirm("Clear all checkboxes for this month?")) {
            habits.forEach(h => {
                h.days = Array(DAYS_COUNT).fill(0);
            });
            save();
            render();
        }
    }

    function save() {
        try {
            storage.setItem(DATA_KEY, JSON.stringify(habits));
        } catch(e) {
            console.warn('Failed to save data:', e);
        }
    }

    function saveMeta() {
        try {
            const meta = {
                month: document.getElementById('monthSelect').value,
                year: document.getElementById('yearSelect').value
            };
            storage.setItem(META_KEY, JSON.stringify(meta));
        } catch(e) {
            console.warn('Failed to save metadata:', e);
        }
    }

    // Notification Functions
    function toggleNotification() {
        try {
            const toggle = document.getElementById('notifyToggle').checked;
            const settings = JSON.parse(storage.getItem('notification_settings')) || {};
            settings.enabled = toggle;
            storage.setItem('notification_settings', JSON.stringify(settings));
            
            if(toggle) {
                requestNotificationPermission();
            }
        } catch(e) {
            console.warn('Failed to toggle notification:', e);
        }
    }

    function updateNotifyTime() {
        try {
            const time = document.getElementById('notifyTime').value;
            const settings = JSON.parse(storage.getItem('notification_settings')) || {};
            settings.time = time;
            storage.setItem('notification_settings', JSON.stringify(settings));
        } catch(e) {
            console.warn('Failed to update notification time:', e);
        }
    }

    function requestNotificationPermission() {
        if('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }

    function testNotification() {
        if('Notification' in window && Notification.permission === 'granted') {
            new Notification('Checkmate Reminder! ðŸŽ¯', {
                body: 'Time to complete your daily habits! Keep your streaks alive!',
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75" fill="%231d4ed8">â™š</text></svg>'
            });
        } else if('Notification' in window) {
            alert('Please enable notifications in your browser settings first.\n(Settings -> Privacy and security -> Site Settings -> Notifications)');
        }
    }

    function checkAndNotify() {
        try {
            const settings = JSON.parse(storage.getItem('notification_settings')) || {};
            if(!settings.enabled) return;
            
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const notifyTime = settings.time || '19:00';
        
            // Check if current time matches notification time
            if(currentTime === notifyTime) {
                if('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Checkmate Daily Reminder! ðŸŽ¯', {
                        body: 'Time to complete your daily habits! Keep your streaks alive!',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75" fill="%231d4ed8">â™š</text></svg>'
                    });
                }
            }
        } catch(e) {
            console.warn('Failed to check notification:', e);
        }
    }

    // Load notification settings on init
    function initNotifications() {
        try {
            const settings = JSON.parse(storage.getItem('notification_settings')) || { enabled: false, time: '19:00' };
            document.getElementById('notifyToggle').checked = settings.enabled;
            document.getElementById('notifyTime').value = settings.time || '19:00';
            
            // Check for notifications every minute
            setInterval(checkAndNotify, 60000);
        } catch(e) {
            console.warn('Failed to initialize notifications:', e);
        }
    }

    init();
    initNotifications();

</script>
</body>
</html>